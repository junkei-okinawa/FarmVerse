# ESP32-S3 ユニットテスト調査 - サマリー

**調査期間**: 2025-10-19 〜 2025-11-02  
**対象**: XIAO ESP32-S3 Sense（Rust/esp-idf-svc）  
**目的**: 実機を使用しないユニットテスト手法の確立

---

## エグゼクティブサマリー

ESP32-S3プロジェクトでのユニットテスト戦略として、以下の**3層アプローチ**を推奨します：

1. **ホストマシンユニットテスト**（高速・高頻度）
2. **probe-rs実機テスト**（自動化可能・ハードウェア確認）⭐NEW
3. **手動実機テスト**（最終品質保証）

QEMUエミュレータは、ESP32-S3の主要機能（WiFi、カメラ、センサー）が非対応のため**非推奨**。

---

## 調査結果一覧

### ❌ QEMU Emulator
**結論**: 非推奨

**理由**:
- ESP-IDF v5.1.6にQEMUツールが統合されていない
- WiFi/ESP-NOW、カメラ、ADCなどが非対応
- Apple SiliconでのXtensaエミュレーション性能問題
- セットアップコストが高く、ROIが低い

**詳細**: `03_INVESTIGATION_REPORT.md` セクション「QEMU Emulator 調査結果」

---

### ✅ ホストマシンユニットテスト
**結論**: 強く推奨（優先度: 高）

**対象範囲**:
- 計算ロジック（電圧変換、温度計算、TDS計算）
- データフォーマット（ESP-NOWフレーム構築）
- 設定パース・バリデーション
- エラーハンドリング

**メリット**:
- ⚡ 高速（秒単位でテスト実行）
- 🔄 CI/CD統合が容易
- 🐛 デバッガー利用可能
- 💰 追加コスト不要

**実装方法**:
```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_voltage_calculation() {
        let result = calculate_voltage_percentage(1629.0, 128.0, 3130.0);
        assert_eq!(result, 50);
    }
}
```

**詳細**: `02_STRATEGY.md` セクション「戦略1」

---

### ⭐ probe-rs + embedded-test（実機テスト）
**結論**: 推奨（優先度: 中）- 今回の新発見

**対象範囲**:
- センサー読み取り（ADC、温度、EC）
- GPIO制御の動作確認
- ペリフェラル初期化
- タイミング依存処理

**メリット**:
- ✅ 実際のハードウェアでテスト
- ✅ `cargo test`で自動実行可能
- ✅ ESP32-S3内蔵USB-JTAG使用（外部HW不要）
- ✅ 各テストごとにデバイスリセット
- ✅ CI/CD統合可能（Self-hosted runner）

**制限事項**:
- ⚠️ Xtensaサポートは発展途上
- ❌ フラッシュ+リセットのオーバーヘッド
- ❌ 実機が必要

**セットアップ時間**: 1〜2日
**ROI評価**: ⭐⭐⭐⭐☆ (4/5)

**詳細**: 
- `03_INVESTIGATION_REPORT.md` セクション「追加調査: probe-rs + embedded-test」
- `04_PROBE_RS_SETUP_GUIDE.md` - 完全なセットアップガイド

---

## 推奨実装ロードマップ

### Phase 1: ホストユニットテスト（1〜2週間）
- [ ] ビジネスロジックを純粋関数として分離
- [ ] `#[cfg(test)]`モジュール追加
- [ ] 計算ロジックのテスト実装
- [ ] CI/CD統合

**成果物**: ホストマシンでユニットテストが実行可能

---

### Phase 2: probe-rs実機テスト（1〜2週間）⭐NEW
- [ ] probe-rsツールインストール
- [ ] テスト用Cargo.toml設定
- [ ] 基本的なGPIO/ADCテスト作成
- [ ] センサーテストの段階的追加

**成果物**: `cargo test`で実機テストが実行可能

---

### Phase 3: CI/CD統合（1週間）
- [ ] GitHub Actions ワークフロー作成
- [ ] Self-hosted runnerセットアップ（probe-rs用）
- [ ] PR時の自動テスト実行

**成果物**: 自動テストパイプライン稼働

---

## テストカバレッジ目標

| コンポーネント | テスト方法 | カバレッジ目標 | 優先度 |
|--------------|----------|--------------|-------|
| 計算ロジック | ホストユニット | 90%+ | 🔴 高 |
| データフォーマット | ホストユニット | 90%+ | 🔴 高 |
| センサー読み取り | probe-rs実機 | 80%+ | 🟡 中 |
| GPIO/ペリフェラル | probe-rs実機 | 70%+ | 🟡 中 |
| WiFi/ESP-NOW | 手動実機 | エンドツーエンド | 🟢 低 |
| カメラ撮影 | 手動実機 | エンドツーエンド | 🟢 低 |

---

## コスト・ベネフィット分析

### 初期投資
| 項目 | 時間 | 難易度 |
|-----|------|-------|
| ホストテスト環境 | 1週間 | 低 |
| probe-rs環境 | 1〜2日 | 中 |
| CI/CD統合 | 1週間 | 中 |
| **合計** | **2〜3週間** | **中** |

### 継続的なベネフィット
- ✅ バグの早期発見（開発時）
- ✅ リグレッション防止
- ✅ リリース品質向上
- ✅ デバッグ時間削減（特にセンサー関連）
- ✅ 開発サイクルの高速化

### 投資対効果（ROI）
- **ホストユニットテスト**: ⭐⭐⭐⭐⭐ (5/5) - 即効性あり
- **probe-rs実機テスト**: ⭐⭐⭐⭐☆ (4/5) - 中長期的価値
- **QEMU**: ⭐☆☆☆☆ (1/5) - 非推奨

---

## 次のアクション

### 即座に実行すべき項目（今週）
1. ✅ 調査レポート完成
2. **Phase 1の開始判断**
   - チームでのテスト戦略の合意形成
   - 最初のユニットテスト実装

### 短期（1ヶ月以内）
1. ホストユニットテストのカバレッジ30%達成
2. probe-rs環境のPoC実施
3. センサーテストの基礎実装

### 中期（3ヶ月以内）
1. テストカバレッジ70%達成
2. CI/CD統合完了
3. probe-rs実機テストの定期実行

---

## 技術資料

### 作成ドキュメント一覧
1. **`00_README.md`** - テストドキュメント全体のインデックス
2. **`01_SUMMARY.md`** - 本サマリー（このファイル）
3. **`02_STRATEGY.md`** - テスト戦略の全体像
4. **`03_INVESTIGATION_REPORT.md`** - 詳細調査レポート
5. **`04_PROBE_RS_SETUP_GUIDE.md`** - probe-rsセットアップ手順⭐NEW
6. **`05_PROBE_RS_README.md`** - embedded-test公式README（参考）

### 参考リソース
- [probe-rs公式](https://probe.rs/)
- [embedded-testクレート](https://crates.io/crates/embedded-test)
- [Rust on ESP Book](https://esp-rs.github.io/book/)
- [ESP-IDF QEMU Doc](https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/api-guides/tools/qemu.html)

---

## 結論

**QEMUは非推奨**。代わりに、**ホストユニットテスト**を基盤とし、
**probe-rs実機テスト**で補完する3層戦略が最適。

この戦略により、以下を実現：
- 🚀 開発速度の向上
- 🎯 テストカバレッジの確保
- 🛡️ 品質の向上
- 💰 コストパフォーマンスの最適化

**推奨**: Phase 1（ホストテスト）から開始し、段階的にPhase 2（probe-rs）を導入。

---

**最終更新**: 2025-11-02  
**作成者**: junkei-okinawa  
**プロジェクト**: FarmVerse/devices/xiao_esp32s3_sense
