# XIAO ESP32S3 Sense - FarmVerse Streaming Camera Device

## ğŸ“‹ æ¦‚è¦

FarmVerseè¾²æ¥­ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®é€ä¿¡ãƒ‡ãƒã‚¤ã‚¹å®Ÿè£…ã§ã™ã€‚XIAO ESP32S3 Senseã‚’ä½¿ç”¨ã—ã¦OV2640ã‚«ãƒ¡ãƒ©ã§ç”»åƒã‚’æ’®å½±ã—ã€ESP-NOWãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é€ä¿¡ã‚’è¡Œã„ã¾ã™ã€‚

## ğŸ“Š æœ€æ–°ãƒ†ã‚¹ãƒˆçµæœ (2025å¹´8æœˆ11æ—¥)

### âœ… **å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæˆåŠŸ**
- **ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£**: OV2640ã‚«ãƒ¡ãƒ©ã§ **13,291ãƒã‚¤ãƒˆ** ã®å®Ÿç”»åƒã‚’å–å¾—
- **ãƒãƒ£ãƒ³ã‚¯é€ä¿¡**: 250ãƒã‚¤ãƒˆÃ—54ãƒãƒ£ãƒ³ã‚¯ã§å®Œå…¨é€ä¿¡æˆåŠŸ
- **ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: ESP-NOWã«ã‚ˆã‚‹HASHâ†’DATAâ†’EOFé€ä¿¡å®Œäº†
- **è¨­å®šåˆ¶å¾¡**: cfg.tomlã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆè¨­å®šãŒæ­£å¸¸å‹•ä½œ

### ğŸ¯ æ¤œè¨¼æ¸ˆã¿æ©Ÿèƒ½
```bash
# å®Ÿéš›ã®é€ä¿¡ãƒ­ã‚° (2025-08-11å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆ)
I sensor_data_sender: ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†: 13291 bytes
I sensor_data_sender: ç”»åƒãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†: 54ãƒãƒ£ãƒ³ã‚¯é€ä¿¡ (ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º: 250ãƒã‚¤ãƒˆ)
I sensor_data_sender: ãƒãƒƒã‚·ãƒ¥ãƒ•ãƒ¬ãƒ¼ãƒ é€ä¿¡: HASH:000033eb00117b94,VOLT:0,TEMP:-999.0
I sensor_data_sender: EOF ãƒãƒ¼ã‚«ãƒ¼é€ä¿¡å®Œäº†
```

## ğŸ”‹ ãƒãƒƒãƒ†ãƒªãƒ¼é§†å‹•æœ€é©åŒ– (2026å¹´1æœˆ25æ—¥æ›´æ–°)

ãƒãƒƒãƒ†ãƒªãƒ¼å˜ç‹¬é§†å‹•æ™‚ã®å®‰å®šæ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã®æœ€é©åŒ–è¨­å®šã¨èª¿æŸ»çµæœã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚
è©³ç´°ãªé›»åœ§é–¾å€¤ã‚„æ¨å¥¨è¨­å®šã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

- **[ãƒãƒƒãƒ†ãƒªãƒ¼é§†å‹•æœ€é©åŒ–ãƒ¬ãƒãƒ¼ãƒˆ (BATTERY_OPT_REPORT.md)](./BATTERY_OPT_REPORT.md)**

## ğŸ“¡ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å…¨ä½“å›³
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ xiao_esp32s3_sense  â”‚ â† ã“ã®ãƒ‡ãƒã‚¤ã‚¹
â”‚   (Sender ESP32-S3) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ ESP-NOW Frame Protocol
           â”‚ (START: 0xFACEAABB, END: 0xCDEF5678)
           â”‚ big-endian markers / little-endian data fields
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USB_CDC_Receiver    â”‚
â”‚  (ESP32-C3)         â”‚
â”‚                     â”‚
â”‚ 1. ESP-NOWå—ä¿¡      â”‚
â”‚    â†“                â”‚
â”‚ 2. ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°   â”‚
â”‚    â†“                â”‚
â”‚ 3. USB CDCé€ä¿¡      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ USB CDC (é€éè»¢é€)
           â”‚ ESP-NOW Frameã‚’ãã®ã¾ã¾è»¢é€
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚sensor_data_receiver â”‚
â”‚   (Python/PC)       â”‚
â”‚  Frame Parser       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ—ãƒ­ãƒˆã‚³ãƒ«éšå±¤

æœ¬ã‚·ã‚¹ãƒ†ãƒ ã§ã¯2ã¤ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™:

#### Protocol 1: ESP-NOW Frame Protocol (xiao_esp32s3_sense â†’ USB_CDC_Receiver)

**å®Ÿè£…å ´æ‰€**:
- **é€ä¿¡å´**: `devices/xiao_esp32s3_sense/src/communication/esp_now/sender.rs`
  - `create_sensor_data_frame()` é–¢æ•°
- **å—ä¿¡å´**: `server/usb_cdc_receiver/src/esp_now/frame.rs`
  - `Frame::from_bytes()` é–¢æ•°

**ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ ** (27+ ãƒã‚¤ãƒˆ):
```
Offset  Size  Field           Value/Format        Endian
------  ----  --------------  ------------------  -------
0       4     START_MARKER    0xFACEAABB          big
4       6     MAC_ADDRESS     é€ä¿¡å…ƒMAC           -
10      1     FRAME_TYPE      1=HASH,2=DATA,3=EOF -
11      4     SEQUENCE_NUM    ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·       little
15      4     DATA_LEN        ãƒ‡ãƒ¼ã‚¿é•·             little
19      N     DATA            å®Ÿãƒ‡ãƒ¼ã‚¿             -
19+N    4     CHECKSUM        XORãƒã‚§ãƒƒã‚¯ã‚µãƒ       little
23+N    4     END_MARKER      0xCDEF5678          big
```

**ãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—** (XOR):
```rust
fn calculate_xor_checksum(data: &[u8]) -> u32 {
    data.iter().fold(0u32, |acc, &byte| acc ^ (byte as u32))
}
```

#### Protocol 2: USB CDC Streaming Protocol (USB_CDC_Receiver â†’ sensor_data_receiver)

USB_CDC_Receiverã¯å—ä¿¡ã—ãŸESP-NOW Frameã‚’**ãã®ã¾ã¾é€éè»¢é€**ã—ã¾ã™ã€‚
sensor_data_receiver (Python)ãŒESP-NOW Frame Protocolã‚’ç›´æ¥è§£æã—ã¾ã™ã€‚

**é‡è¦ãªæ³¨æ„ç‚¹**:
- âœ… ãƒãƒ¼ã‚«ãƒ¼(START/END)ã¯big-endian
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰(SEQUENCE_NUM, DATA_LENç­‰)ã¯little-endian
- âœ… USB CDC Receiverã¯ãƒ•ãƒ¬ãƒ¼ãƒ å¤‰æ›ãªã—ï¼ˆé€éè»¢é€ã®ã¿ï¼‰

### ESP-NOW Frame Protocol ä»•æ§˜

**å®Ÿè£…å ´æ‰€**:
- é€ä¿¡: `src/communication/esp_now/sender.rs` - `create_sensor_data_frame()`
- å—ä¿¡: `server/usb_cdc_receiver/src/esp_now/frame.rs` - `Frame::from_bytes()`
- è§£æ: `server/sensor_data_reciver/protocol/frame_parser.py` - `FrameParser`

**ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ ** (27+ ãƒã‚¤ãƒˆ):
```
Offset  Size  Field           Value/Format        Endian
------  ----  --------------  ------------------  -------
0       4     START_MARKER    0xFACEAABB          big
4       6     MAC_ADDRESS     é€ä¿¡å…ƒMAC           -
10      1     FRAME_TYPE      1=HASH,2=DATA,3=EOF -
11      4     SEQUENCE_NUM    ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·       little
15      4     DATA_LEN        ãƒ‡ãƒ¼ã‚¿é•·             little
19      N     DATA            å®Ÿãƒ‡ãƒ¼ã‚¿             -
19+N    4     CHECKSUM        XORãƒã‚§ãƒƒã‚¯ã‚µãƒ       little
23+N    4     END_MARKER      0xCDEF5678          big
```

**ãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—** (XOR):
```rust
fn calculate_xor_checksum(data: &[u8]) -> u32 {
    data.iter().fold(0u32, |acc, &byte| acc ^ (byte as u32))
}
```

**é‡è¦**: 
- USB CDC Receiverã¯**é€éè»¢é€**ã®ã¿ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ å¤‰æ›ãªã—ï¼‰
- sensor_data_receiver (Python)ãŒESP-NOW Frameã‚’ç›´æ¥è§£æ
- ãƒãƒ¼ã‚«ãƒ¼ã¯big-endianã€ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯little-endian

## ğŸ¯ ä¸»è¦æ©Ÿèƒ½

### âœ… å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½
- **å®Ÿæ©Ÿã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£**: OV2640ã‚»ãƒ³ã‚µãƒ¼ã«ã‚ˆã‚‹UXGA(1600x1200)ç”»åƒæ’®å½± âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**
- **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é€ä¿¡**: ESP-NOWãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ã‚ˆã‚‹ç”»åƒãƒãƒ£ãƒ³ã‚¯åˆ†å‰²é€ä¿¡ âœ… **13.2KBç”»åƒé€ä¿¡æˆåŠŸ**
- **é›»åŠ›ç®¡ç†**: ADCé›»åœ§ç›£è¦–ã¨ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡ âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿**
- **è¨­å®šç®¡ç†**: cfg.tomlã«ã‚ˆã‚‹æŸ”è»Ÿãªè¨­å®šå¤‰æ›´ âœ… **ãƒ†ã‚¹ãƒˆè¨­å®šå®Ÿè£…å®Œäº†**
- **ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½**: é–‹ç™ºç”¨ã®è©³ç´°åˆ¶å¾¡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ âœ… **å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆå¯¾å¿œå®Œäº†**

### ğŸš€ æ¬¡æœŸå®Ÿè£…äºˆå®š
- **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼ãƒ»ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹
- **ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ**: è¤‡æ•°ã‚»ãƒ³ã‚µãƒ¼ã®ä¸¦è¡Œé€ä¿¡
- **é«˜åº¦ãªé›»åŠ›ç®¡ç†**: æ™‚åˆ»åˆ¶å¾¡ãƒ»ç’°å¢ƒé©å¿œã‚¹ãƒªãƒ¼ãƒ—

## ğŸ› ï¸ ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢æ§‹æˆ

### å¿…è¦ãƒ‡ãƒã‚¤ã‚¹
- **XIAO ESP32S3 Sense** (8MB PSRAM, WiFi/BLEå¯¾å¿œ)
- **OV2640ã‚«ãƒ¡ãƒ©ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«** (å†…è”µ)
- **ADCé›»åœ§ã‚»ãƒ³ã‚µãƒ¼** (GPIO6)
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹LED** (GPIO21)

### ãƒ”ãƒ³é…ç½®
```
ã‚«ãƒ¡ãƒ©ãƒ”ãƒ³é…ç½® (OV2640):
- XCLK: GPIO10    - SIOD: GPIO40    - VSYNC: GPIO46
- PCLK: GPIO13    - SIOC: GPIO39    - HREF:  GPIO38  
- D0-D7: GPIO15,GPIO17,GPIO18,GPIO16,GPIO14,GPIO12,GPIO11,GPIO48

ãã®ä»–:
- ADC: GPIO6 (é›»åœ§æ¸¬å®š)
- LED: GPIO21 (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º)
```

## âš™ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« (cfg.toml)

### åŸºæœ¬è¨­å®š
```toml
[sensor-data-sender]
# å—ä¿¡æ©ŸMACã‚¢ãƒ‰ãƒ¬ã‚¹
receiver_mac = "24:EC:4A:CA:5E:BC"

# ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“è¨­å®š
sleep_duration_seconds = 600        # é€šå¸¸ã‚¹ãƒªãƒ¼ãƒ— (10åˆ†)
sleep_duration_seconds_medium = 3600 # èª¿æ•´ã‚¹ãƒªãƒ¼ãƒ— (1æ™‚é–“)
sleep_duration_seconds_for_long = 32400 # ãƒ­ãƒ³ã‚°ã‚¹ãƒªãƒ¼ãƒ— (9æ™‚é–“)

# ã‚«ãƒ¡ãƒ©è¨­å®š  
frame_size = "UXGA"                 # 1600x1200è§£åƒåº¦
auto_exposure_enabled = true
camera_warmup_frames = 2

# é€šä¿¡è¨­å®š
esp_now_chunk_size = 250           # ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º (ãƒã‚¤ãƒˆ)
esp_now_chunk_delay_ms = 5         # ãƒãƒ£ãƒ³ã‚¯é–“é…å»¶ (ãƒŸãƒªç§’)
```

### ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°è¨­å®š
```toml
# ãƒ†ã‚¹ãƒˆç”¨è¨­å®š (å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæ¸ˆã¿ - 2025å¹´8æœˆ11æ—¥)
force_camera_test = true           # ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆå¼·åˆ¶å®Ÿè¡Œ âœ… å‹•ä½œç¢ºèªæ¸ˆã¿
bypass_voltage_threshold = true    # é›»åœ§ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹ âœ… å‹•ä½œç¢ºèªæ¸ˆã¿
debug_mode = true                  # è©³ç´°ãƒ­ã‚°å‡ºåŠ› âœ… å‹•ä½œç¢ºèªæ¸ˆã¿
```

### å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆç”¨è¨­å®šä¾‹
```toml
# ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆã‚’å¼·åˆ¶å®Ÿè¡Œ (é›»åœ§0%ã§ã‚‚æ’®å½±)
force_camera_test = true
bypass_voltage_threshold = true
debug_mode = true

# æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ:
# - ADCé›»åœ§0%ã§ã‚‚ã‚«ãƒ¡ãƒ©ã‚­ãƒ£ãƒ—ãƒãƒ£å®Ÿè¡Œ
# - ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒè©³ç´°å‡ºåŠ›
# - å®Ÿç”»åƒãƒ‡ãƒ¼ã‚¿(~13KB)ã®ESP-NOWé€ä¿¡
```

## ğŸš€ ãƒ“ãƒ«ãƒ‰ãƒ»å®Ÿè¡Œ

### ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
# Rust ESP32é–‹ç™ºç’°å¢ƒã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
cargo install cargo-espflash
rustup target add xtensa-esp32s3-espidf

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
cargo build
```

### ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ»å®Ÿè¡Œ
```bash
# ãƒ‡ãƒã‚¤ã‚¹ã¸ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ (ãƒ¢ãƒ‹ã‚¿ãƒ¼ä»˜ã)
cargo espflash flash --partition-table partitions.csv --monitor

# ãƒ“ãƒ«ãƒ‰ã®ã¿
cargo build
```

### ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã§ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ (ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢éä¾å­˜éƒ¨åˆ†)
```bash
# ãƒ›ã‚¹ãƒˆãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
./run_tests.sh

# å®Ÿè¡Œã•ã‚Œã‚‹ãƒ†ã‚¹ãƒˆ:
# - utils::voltage_calc (é›»åœ§è¨ˆç®—)
# - utils::tds_calc (TDSè¨ˆç®—)
# - utils::streaming_protocol (é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«)
# - mac_address (MACã‚¢ãƒ‰ãƒ¬ã‚¹å‡¦ç†)
# - core::measured_data (æ¸¬å®šãƒ‡ãƒ¼ã‚¿)
```

### å®Ÿæ©Ÿçµ±åˆãƒ†ã‚¹ãƒˆ (ESP32S3å®Ÿæ©ŸãŒå¿…è¦)
```bash
# âš ï¸ æ³¨æ„: çµ±åˆãƒ†ã‚¹ãƒˆã¯å®Ÿæ©Ÿç’°å¢ƒãŒå¿…è¦

# 1. ESP-IDFç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ESP-IDFã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‘ã‚¹ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚Šã¾ã™
# ä¾‹: . ~/esp/v5.1.6/esp-idf/export.sh
# ã¾ãŸã¯ç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨: . $IDF_PATH/export.sh
. ~/esp/v5.1.6/esp-idf/export.sh

# 2. å®Ÿæ©Ÿæ¥ç¶šç¢ºèª
ls /dev/tty.usbserial-*  # macOS
ls /dev/ttyUSB*          # Linux

# 3. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ (å®Ÿæ©Ÿãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆ)
cargo test --lib integration_tests

# Note: çµ±åˆãƒ†ã‚¹ãƒˆã¯ src/lib.rs::integration_tests ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å®Ÿè£…
# ESP-IDF ä¾å­˜ã®ãŸã‚ã€å®Ÿæ©ŸãŒå¿…è¦
```

## ğŸ“Š å‹•ä½œãƒ•ãƒ­ãƒ¼

```
1. èµ·å‹•ãƒ»åˆæœŸåŒ–
   â”œâ”€ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ (cfg.toml)
   â”œâ”€ WiFi/ESP-NOWåˆæœŸåŒ–
   â”œâ”€ ADCé›»åœ§æ¸¬å®š
   â””â”€ ãƒšãƒªãƒ•ã‚§ãƒ©ãƒ«åˆæœŸåŒ–

2. ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£åˆ¤å®š
   â”œâ”€ é›»åœ§ãƒã‚§ãƒƒã‚¯ (> 8% or bypass_voltage_threshold)
   â”œâ”€ å¼·åˆ¶å®Ÿè¡Œãƒã‚§ãƒƒã‚¯ (force_camera_test)
   â””â”€ ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ãƒ»æ’®å½±

3. ãƒ‡ãƒ¼ã‚¿é€ä¿¡
   â”œâ”€ ç”»åƒãƒãƒ£ãƒ³ã‚¯åˆ†å‰² (250ãƒã‚¤ãƒˆå˜ä½)
   â”œâ”€ ESP-NOWé€ä¿¡ (ãƒãƒ£ãƒ³ã‚¯â†’HASHâ†’EOF)
   â””â”€ é€ä¿¡å®Œäº†ç¢ºèª

4. ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡
   â”œâ”€ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¹ãƒªãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰å¾…æ©Ÿ (10ç§’)
   â”œâ”€ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ä½¿ç”¨
   â””â”€ ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ãƒªãƒ¼ãƒ—ç§»è¡Œ
```

## ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°

### ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

å®Ÿæ©Ÿï¼ˆESP32S3ï¼‰ä¸è¦ã§ã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ï¼ˆMac/Linux/Windowsï¼‰ã§å®Ÿè¡Œå¯èƒ½ãªãƒ†ã‚¹ãƒˆã§ã™ã€‚

```bash
# ã™ã¹ã¦ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
./run_tests.sh

# ã¾ãŸã¯å€‹åˆ¥å®Ÿè¡Œ
# ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆçµ±åˆãƒ†ã‚¹ãƒˆ11ä»¶å«ã‚€ï¼‰
cd src/utils
rustc +stable --test streaming_protocol.rs --edition 2021 -o ../../target/streaming_tests
../../target/streaming_tests

# é›»åœ§è¨ˆç®—ãƒ†ã‚¹ãƒˆ
cd src/utils
rustc +stable --test voltage_calc.rs --edition 2021 -o ../../target/voltage_tests
../../target/voltage_tests
```

### ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œï¼ˆå®Ÿæ©ŸãŒå¿…è¦ï¼‰
```toml
# cfg.tomlã§ä»¥ä¸‹ã‚’è¨­å®š
force_camera_test = true
bypass_voltage_threshold = true
debug_mode = true
```

### ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ç¢ºèª
```bash
# ã‚·ãƒªã‚¢ãƒ«ãƒ¢ãƒ‹ã‚¿ãƒ¼ä»˜ããƒ•ãƒ©ãƒƒã‚·ãƒ¥
cargo espflash flash --partition-table partitions.csv --monitor

# æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚°å‡ºåŠ›ä¾‹:
# I sensor_data_sender: ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£é–‹å§‹ - é›»åœ§:0%, force_camera_test:true
# I sensor_data_sender: ğŸ”§ ãƒ‡ãƒãƒƒã‚°: ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆã‚’å¼·åˆ¶å®Ÿè¡Œä¸­
# I sensor_data_sender: ç”»åƒã‚­ãƒ£ãƒ—ãƒãƒ£ã‚’é–‹å§‹ (é›»åœ§:0%, å¼·åˆ¶å®Ÿè¡Œ:true)
```

### ã‚¨ãƒ©ãƒ¼å¯¾å‡¦
```bash
# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼æ™‚
cargo check

# ãƒ“ãƒ«ãƒ‰ã‚¯ãƒªãƒ¼ãƒ³
cargo clean && cargo build

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿæˆ
rm cfg.toml.template && cp cfg.toml.template cfg.toml
```

## ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

```
src/
â”œâ”€â”€ main.rs                    # ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ lib.rs                     # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ«ãƒ¼ãƒˆ
â”œâ”€â”€ config.rs                  # è¨­å®šç®¡ç†
â”œâ”€â”€ mac_address.rs             # MACã‚¢ãƒ‰ãƒ¬ã‚¹å‡¦ç†
â”œâ”€â”€ communication/
â”‚   â””â”€â”€ esp_now/
â”‚       â”œâ”€â”€ mod.rs             # ESP-NOWãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚       â”œâ”€â”€ sender.rs          # ãƒ‡ãƒ¼ã‚¿é€ä¿¡æ©Ÿèƒ½
â”‚       â”œâ”€â”€ receiver.rs        # ãƒ‡ãƒ¼ã‚¿å—ä¿¡æ©Ÿèƒ½
â”‚       â”œâ”€â”€ frame.rs           # ãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†
â”‚       â””â”€â”€ streaming.rs       # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ (å®Ÿè£…ä¸­)
â”œâ”€â”€ hardware/
â”‚   â”œâ”€â”€ camera/
â”‚   â”‚   â”œâ”€â”€ mod.rs             # ã‚«ãƒ¡ãƒ©ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â”‚   â”‚   â”œâ”€â”€ controller.rs      # OV2640åˆ¶å¾¡
â”‚   â”‚   â”œâ”€â”€ config.rs          # ã‚«ãƒ¡ãƒ©è¨­å®š
â”‚   â”‚   â”œâ”€â”€ ov2640.rs          # OV2640ãƒ‰ãƒ©ã‚¤ãƒãƒ¼
â”‚   â”‚   â””â”€â”€ xiao_esp32s3.rs    # XIAO ESP32S3è¨­å®š
â”‚   â”œâ”€â”€ led/
â”‚   â”‚   â””â”€â”€ status_led.rs      # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹LEDåˆ¶å¾¡
â”‚   â””â”€â”€ voltage_sensor.rs      # ADCé›»åœ§æ¸¬å®š
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â”œâ”€â”€ app_controller.rs      # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡
â”‚   â”œâ”€â”€ data_service.rs        # ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚µãƒ¼ãƒ“ã‚¹
â”‚   â”œâ”€â”€ config.rs              # è¨­å®šå‡¦ç†
â”‚   â””â”€â”€ rtc_manager.rs         # æ™‚åˆ»ç®¡ç†
â”œâ”€â”€ power/
â”‚   â”œâ”€â”€ mod.rs
â”‚   â””â”€â”€ sleep/
â”‚       â””â”€â”€ deep_sleep.rs      # ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡
â””â”€â”€ tests/
    â”œâ”€â”€ mod.rs                 # ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    â”œâ”€â”€ camera_tests.rs        # ã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆ
    â”œâ”€â”€ streaming_tests.rs     # ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
    â””â”€â”€ large_image_tests.rs   # å¤§å®¹é‡ç”»åƒãƒ†ã‚¹ãƒˆ
```

## ğŸ¯ é–‹ç™ºãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### âœ… ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤å®Ÿè£… (âœ… **å®Œäº† - å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆæˆåŠŸ**)
- [x] XIAO ESP32S3ã‚«ãƒ¡ãƒ©åˆæœŸåŒ– âœ… **OV2640å‹•ä½œç¢ºèªæ¸ˆã¿**
- [x] ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é€ä¿¡åŸºç›¤ âœ… **13.2KBç”»åƒé€ä¿¡æˆåŠŸ**
- [x] ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ âœ… **cfg.tomlåˆ¶å¾¡å®Ÿè£…å®Œäº†**
- [x] è¨­å®šç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  âœ… **force_camera_testç­‰å‹•ä½œç¢ºèªæ¸ˆã¿**

### ğŸš€ ãƒ•ã‚§ãƒ¼ã‚º2: ä¸­ç¶™å´å®Ÿè£… (æ¬¡æœŸ)
- [ ] usb_cdc_receiver Streaming Architecture
- [ ] ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹ä¸¦è¡Œå‡¦ç†
- [ ] ãƒãƒƒã‚¯ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼åˆ¶å¾¡

### ğŸ¯ ãƒ•ã‚§ãƒ¼ã‚º3: ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ (å°†æ¥)
- [ ] End-to-Endçµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] æ€§èƒ½æœ€é©åŒ–
- [ ] æœ¬ç•ªç’°å¢ƒå¯¾å¿œ

## ğŸ“‹ é–¢é€£Issue

- **[#11 - FarmVerse StreamingåŒ–å®Ÿè£…](https://github.com/junkei-okinawa/FarmVerse/issues/11)** (Epic)
- **[#12 - é€ä¿¡å´XIAO ESP32S3 Senseå¯¾å¿œå®Ÿè£…](https://github.com/junkei-okinawa/FarmVerse/issues/12)** (Current)
- **[#13 - ä¸­ç¶™usb_cdc_receiver Streaming Architectureå®Ÿè£…](https://github.com/junkei-okinawa/FarmVerse/issues/13)** (Next)

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–å¤±æ•—**
   ```
   è§£æ±ºæ–¹æ³•: é›»æºä¾›çµ¦ã®ç¢ºèªã€ãƒ”ãƒ³é…ç½®ã®å†ç¢ºèª
   ```

2. **ESP-NOWé€ä¿¡å¤±æ•—**
   ```
   è§£æ±ºæ–¹æ³•: å—ä¿¡æ©ŸMACã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç¢ºèªã€WiFiãƒãƒ£ãƒ³ãƒãƒ«è¨­å®š
   ```

3. **ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼**
   ```
   è§£æ±ºæ–¹æ³•: PSRAMã®æœ‰åŠ¹åŒ–ç¢ºèªã€ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚ºã®èª¿æ•´
   ```

### ã‚µãƒãƒ¼ãƒˆæƒ…å ±
- **é–‹ç™ºç’°å¢ƒ**: ESP-IDF v5.1.3, Rust 1.80+
- **å¯¾è±¡ãƒ‡ãƒã‚¤ã‚¹**: XIAO ESP32S3 Sense
- **é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: ESP-NOW
- **ç”»åƒå½¢å¼**: JPEG (OV2640å‡ºåŠ›)

---

**æ›´æ–°æ—¥**: 2025å¹´8æœˆ11æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v0.2.0  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **ãƒ•ã‚§ãƒ¼ã‚º1å®Œäº†ã€å®Ÿæ©Ÿã‚«ãƒ¡ãƒ©ãƒ†ã‚¹ãƒˆæˆåŠŸ (13.2KBç”»åƒé€ä¿¡ç¢ºèª)**
