# バッテリー駆動問題解決: 最適化レポート

XIAO ESP32S3 Senseにおけるバッテリー駆動時のリセットループ問題（Brownout）に対し、多角的な省電力対策を実施しました。
最終的に、**ハードウェア的な電圧確保とソフトウェア的な電力削減策の組み合わせ**により、安定動作を実現しました。

## 実装済みの省電力設定（推奨）

以下の設定は、バッテリー駆動の安定性と効率を最大化するために**維持することを強く推奨**します。

### 1. CPU周波数の削減 (240MHz → 80MHz)
- **設定**: `sdkconfig.defaults` -> `CONFIG_ESP32S3_DEFAULT_CPU_FREQ_MHZ=80`
- **理由**: ベース消費電流を大幅に削減（推定30-50mA減）。処理速度より安定性を優先。

### 2. WiFi送信パワー削減 (20dBm → 8dBm)
- **設定**: `cfg.toml` -> `wifi_tx_power_dbm = 8`
- **理由**: 送信時のピーク電流（突入電流）を抑制し、電圧降下を防ぐ。

---

## 最低駆動電圧に関する調査

本システムの安定稼働に必要な最低バッテリー電圧についての調査記録です。

### 測定結果

| バッテリー電圧 | 挙動 | 結果 | 備考 |
|---|---|---|---|
| **3.5V** | 起動失敗またはリセットループ | ❌ | LDOドロップアウト発生 |
| **3.8V** | 正常起動 → 撮影 → 送信 → DeepSleep | ✅ | 安定稼働ライン（暫定） |
| **[調査予定]** | | | |
| **[調査予定]** | | | |

> **追記**: ここに詳細な電圧と挙動の調査結果を追記してください。

---

## Light Sleep消費電力異常の調査 (2026-02-01)

Deep Sleep/Light Sleepのハイブリッド運用において、Light Sleep期間中（10分間）にバッテリー残量が約2%減少する現象が確認されました。
これは平均電流にして約90mAの消費に相当し、Light Sleepの想定電流（数百uA〜数mA）を大きく逸脱しています。

### 1. 実施した対策
* **Light Sleep復帰後のGPIO Hold解除**: `main.rs` にて、復帰直後に全ピンの `gpio_hold_dis` を実行する処理を追加。
* **カメラピンのハイインピーダンス化**: 画像取得後に `reset_camera_pins()` を呼び出し、カメラ関連ピンをフローティング/プルダウン状態にする処理を有効化。
* **センサー電源の遮断**: Light Sleep移行前に温度/TDSセンサー用電源ピン (GPIO 2, 5) を明示的にLow出力する処理を追加。

### 2. 現在の仮説
1.  **カメラモジュール (OV2640) の待機電力**: 90mAという数値はOV2640のアイドル時消費電流に近いことから、カメラのPower Down (PWDN) が正しく機能していない、あるいは電源ラインが遮断されていない可能性が高い。
2.  **起動/通信コストの影響**: Sleep中のリークではなく、WiFi接続・画像送信・DHCP取得などの「稼働時間」における消費電力が支配的である可能性。特に送信遅延やカメラウォームアップ時間が長い場合、頻繁な起動がバッテリーを圧迫する。

### 3. 検証計画
**検証A: Sleep時間の短縮による切り分け（現在進行中）**
*   **方法**: Sleep時間を10分から30秒〜1分に短縮し、単位時間あたりの消費電力が変化するか確認する。
*   **判断基準**:
    *   **変化なし（1サイクルあたりの消費が一定）**: 起動時・稼働時の固定コスト（Active Phase）が原因。
    *   **変化あり（時間が長いほど減る）**: Sleep中のリーク電流（Sleep Phase）が原因。

**検証結果 (2026-02-04)**
*   **条件**: Sleep 30秒 (Cycle ~80秒)
*   **結果**: 10分あたり約2.4%の電圧低下。
*   **比較**: Sleep 10分時の2.0%低下とほぼ同等。
*   **結論**: 稼働頻度を7倍に増やしても消費総量が変わらないことから、**Active時とLight Sleep時の消費電流がほぼ同じ（約90mA）**であると断定。Light Sleep中にカメラ等の周辺機器が正しく停止していないことが原因。

### 4. 対策方針
1.  **カメラクロック (XCLK) の完全停止**:
    *   `reset_camera_pins` で XCLK (GPIO 10) を `OUTPUT LOW` に設定し、クロック供給を物理的に遮断。（実施済み）
2.  **カメラのソフトウェアスタンバイ (SCCB)**:
    *   **対策**: `standby()` メソッドを実装し、OV2640のレジスタ `COM7 (0x12)` の Bit 4 をセットすることで、センサー内部でSleep Modeに移行させる。
    *   **理由**: XCLK停止だけでは改善しなかったため、センサー内部のアナログ回路が動作し続けていると判断。

---
**作成日**: 2026-01-25

---

## 追加調査: OV2640消費電流の根本原因確定 (2026-02-07)

### 原因の確定

デバイスログ分析とOV2640データシート/実測データの調査により、**Light Sleep中の約90mA消費の主因はOV2640カメラモジュール**であることが確定しました。

| 事実 | 内容 |
|---|---|
| **OV2640のデータシート上のStandby電流** | 0.6〜0.9mA |
| **OV2640の実測Standby電流（初期化後）** | **40〜90mA** |
| **PWDNピン** | XIAO ESP32S3 Senseでは**未接続** (-1) |
| **ソフトウェアStandby (COM7 Bit4)** | 効果は限定的（データシート値には到達しない） |
| **唯一の解決策** | **電源の物理的遮断（MOSFET等）** |

> **結論**: OV2640は一度初期化されると、PWDN物理制御なしではソフトウェアコマンドだけでは数十mAの消費電流を避けられない。これはOV2640の既知の問題であり、ハードウェア設計で対処する必要がある。

### 実施した追加対策 (ソフトウェア側)

完全な解決にはハードウェア改修が必要ですが、ソフトウェアで可能な限り消費電力を削減する対策を実施しました。

#### 1. カメラSleep処理の強化
- **CLKRC (0x11) クロック分周器を最大**: 内部クロックを最大分周して消費電力を削減
- **DVP出力速度制御クリア**: DSPバンクのR_DVP_SP (0xD3) を0x00に設定
- **COM7 (0x12) Sleep mode**: System clock & OSC/PLL disable（既存の対策を維持）
- ⚠️ **COM2 (0x09) Standby mode は使用禁止**: [esp32-camera Issue #672](https://github.com/espressif/esp32-camera/issues/672) / [#101](https://github.com/espressif/esp32-camera/issues/101) により、COM2 Bit4をセットするとOV2640がSDAラインをLowにロックし、Light Sleep復帰後のI2C（SCCB）通信が不可能になる。復帰にはpower-cycleが必要。

#### 2. I2Cライン (SDA/SCL) のリーク電流防止
- `reset_camera_pins()` で GPIO 40 (SDA) と GPIO 39 (SCL) を明示的に **Output Low** に設定
- I2Cプルアップ抵抗経由でカメラモジュールにリーク電流が流れるのを防止

#### 3. Light Sleep Power Domain最適化
- **MODEM ドメインを OFF**: WiFi/BLE deinit後の残存電力を遮断
- **RTC_PERIPH ドメインを OFF**: GPIO Holdは RTC_PERIPH OFF でも内部的に維持される（ESP-IDF公式仕様）
- VDDSDIO は ON 維持（PSRAM必須）

#### 4. スリープ閾値バグの修正
- `sleep_optimized()` と `secure_shutdown_and_sleep()` の条件を `<=` → `<` に修正
- **600秒指定時にDeep Sleep**が選択されるように修正（従来はLight Sleepが選択されていた）

#### 5. Light Sleep中のデバッグLED除去
- スリープ突入前のLED点灯（Active Low）処理を除去し、数mAの無駄な消費を排除

### ハードウェア改善の提案

**MOSFET によるカメラ電源遮断回路**の追加を推奨します。

```
3.3V ── [P-ch MOSFET (例: AO3401A)] ── カメラモジュール VCC
              │
         GPIO制御ピン
```

- **制御方法**: GPIO出力でMOSFETのゲートを制御し、カメラ使用時のみ3.3Vを供給
- **効果**: Light Sleep中のカメラ消費電流を0mAに削減可能
- **必要部品**: P-ch MOSFET 1個、ゲート抵抗 1個
- **カメラの再初期化**: 電源投入後に `esp_camera_init()` が再度必要になるが、現在のコードは毎サイクル初期化する設計のため影響なし

### 実行ログ分析結果 (2026-02-06, 2026-02-07)

| テスト条件 | 2/6 (60秒 Light Sleep) | 2/7 (600秒 Light Sleep*) |
|---|---|---|
| **観測期間** | 93分 | 123分 |
| **電圧変化** | 43%→22% (-21%) | 50%→23% (-27%) |
| **サイクル数** | 67回 | 13回 |
| **1時間あたり低下** | 13.5% | 13.2% |
| **画像送信時間** | 12.6〜14.7秒 | 10.4〜11.2秒 |

*\* 600秒は閾値バグによりLight Sleepが選択されていた。修正後はDeep Sleepが選択される。*

> **結論**: Active時間の差（67回 vs 13回）にもかかわらず1時間あたりの消費がほぼ同じであることから、**Light Sleep中の消費電流がActive時と同等**であることが再確認された。
