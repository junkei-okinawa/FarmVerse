# Sensor Data Receiver Python Server

ã“ã®Pythonã‚µãƒ¼ãƒãƒ¼ã¯ã€ESP32ã‚«ãƒ¡ãƒ©ãƒ‡ãƒã‚¤ã‚¹ï¼ˆM5Stack Unit Camï¼‰ã‹ã‚‰ESP-NOWçµŒç”±ã§é€ä¿¡ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ã€InfluxDBã¸ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ã€ç”»åƒä¿å­˜ã€å‹•çš„ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡ã‚’è¡Œã†åŒ…æ‹¬çš„ãªIoTãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

FarmVerseã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸ã¨ãªã‚‹ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ï¼š

- **ESP-NOWç”»åƒãƒ‡ãƒ¼ã‚¿å—ä¿¡**: M5Stack Unit Camã‹ã‚‰ã®é«˜å“è³ªç”»åƒãƒ‡ãƒ¼ã‚¿
- **InfluxDBçµ±åˆ**: é›»åœ§ãƒ»æ¸©åº¦ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•è¨˜éŒ²ã¨æ™‚ç³»åˆ—åˆ†æ
- **å‹•çš„ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡**: ãƒ‡ãƒã‚¤ã‚¹ã®é›»åŠ›åŠ¹ç‡æœ€é©åŒ–
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–**: Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚ˆã‚‹ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç›£è¦–

## ğŸŒŸ ä¸»ãªæ©Ÿèƒ½

### ğŸ“¡ é«˜åº¦ãªé€šä¿¡å‡¦ç†
- **éåŒæœŸã‚·ãƒªã‚¢ãƒ«é€šä¿¡**: `serial_asyncio`ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿å—ä¿¡
- **ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: START/END_MARKERã«ã‚ˆã‚‹ç¢ºå®Ÿãªãƒ•ãƒ¬ãƒ¼ãƒ åŒæœŸ
- **ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ**: MACã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒã‚¤ã‚¹è­˜åˆ¥ãƒ»ç®¡ç†
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: SHA256ãƒãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ç”»åƒãƒ‡ãƒ¼ã‚¿æ¤œè¨¼

### ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ»è¨˜éŒ²
- **InfluxDBçµ±åˆ**: 
  - å…¨é›»åœ§ãƒ¬ãƒ™ãƒ«ï¼ˆ0-100%ï¼‰ã®è‡ªå‹•è¨˜éŒ²
  - æ¸©åº¦ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¨˜éŒ²
  - éåŒæœŸæ›¸ãè¾¼ã¿ã«ã‚ˆã‚‹é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
  - asyncã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
- **ç”»åƒä¿å­˜**: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ãJPEGå½¢å¼ã§ã®è‡ªå‹•ä¿å­˜
- **ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†**: é€ä¿¡ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã¨å—ä¿¡æ™‚åˆ»ã®è¨˜éŒ²

### ğŸ”‹ é›»åŠ›ç®¡ç†ãƒ»åˆ¶å¾¡
- **å‹•çš„ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡**: 
  - HASHãƒ•ãƒ¬ãƒ¼ãƒ å—ä¿¡å¾Œã®é©åˆ‡ãªã‚¹ãƒªãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
  - é›»åœ§ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸæœ€é©ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“ã®æ±ºå®š
  - ä½é›»åœ§ãƒ‡ãƒã‚¤ã‚¹ã¸ã®é•·æ™‚é–“ã‚¹ãƒªãƒ¼ãƒ—æŒ‡ç¤º
- **é›»åœ§ç›£è¦–**: å…¨é›»åœ§ç¯„å›²ï¼ˆ0-100%ï¼‰ã§ã®ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

### ğŸ›¡ï¸ å …ç‰¢æ€§ãƒ»ä¿¡é ¼æ€§
- **åŒ…æ‹¬çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é€šä¿¡ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ‡ãƒ¼ã‚¿ç ´æã¸ã®å¯¾å¿œ
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†**: ãƒªã‚½ãƒ¼ã‚¹ãƒªãƒ¼ã‚¯é˜²æ­¢ã®ãŸã‚ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- **çµ±è¨ˆæƒ…å ±**: å—ä¿¡ç”»åƒæ•°ãƒ»ãƒ‡ãƒ¼ã‚¿é‡ã®å®šæœŸçš„ãªè¨˜éŒ²
- **ãƒ­ã‚°ç®¡ç†**: è©³ç´°ãªãƒ‡ãƒãƒƒã‚°æƒ…å ±ã¨ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®è¨˜éŒ²

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼æ§‹é€ 

```
ğŸ“ sensor_data_reciver/
â”œâ”€â”€ ğŸ¯ config/                 # è¨­å®šç®¡ç†
â”‚   â””â”€â”€ settings.py           # ç’°å¢ƒè¨­å®šãƒ»è¨­å®šå€¤ç®¡ç†
â”œâ”€â”€ ğŸ“¡ protocol/               # é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«
â”‚   â”œâ”€â”€ frame_parser.py       # ãƒ•ãƒ¬ãƒ¼ãƒ è§£æãƒ»æ¤œè¨¼
â”‚   â”œâ”€â”€ serial_handler.py     # ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ãƒ»ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡
â”‚   â””â”€â”€ constants.py          # ãƒ—ãƒ­ãƒˆã‚³ãƒ«å®šæ•°
â”œâ”€â”€ ğŸ”§ processors/             # ãƒ‡ãƒ¼ã‚¿å‡¦ç†
â”‚   â”œâ”€â”€ image_processor.py    # ç”»åƒãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ»ä¿å­˜
â”‚   â”œâ”€â”€ voltage_processor.py  # é›»åœ§ãƒ‡ãƒ¼ã‚¿è§£æ
â”‚   â””â”€â”€ sleep_controller.py   # ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“åˆ¶å¾¡
â”œâ”€â”€ ğŸ’¾ storage/                # ãƒ‡ãƒ¼ã‚¿ä¿å­˜
â”‚   â””â”€â”€ influxdb_client.py    # InfluxDBçµ±åˆãƒ»asyncå‡¦ç†
â”œâ”€â”€ ğŸ” utils/                  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â””â”€â”€ logging_config.py     # ãƒ­ã‚°è¨­å®š
â””â”€â”€ ğŸ“ tests/                  # ãƒ†ã‚¹ãƒˆ
    â”œâ”€â”€ unit/                 # å˜ä½“ãƒ†ã‚¹ãƒˆ
    â””â”€â”€ integration/          # çµ±åˆãƒ†ã‚¹ãƒˆ
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[ESP32 Unit Cam] --> B[ESP-NOWé€ä¿¡]
    B --> C[USB CDC Receiver]
    C --> D[Serial Handler]
    D --> E{ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—}
    E -->|HASH| F[é›»åœ§ãƒ»æ¸©åº¦è§£æ]
    E -->|DATA| G[ç”»åƒãƒ‡ãƒ¼ã‚¿è“„ç©]
    E -->|EOF| H[ç”»åƒä¿å­˜]
    F --> I[InfluxDBè¨˜éŒ²]
    F --> J[ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡]
    G --> H
    H --> K[çµ±è¨ˆæ›´æ–°]
    I --> L[ãƒ‡ãƒã‚¤ã‚¹ç›£è¦–]
    J --> M[ã‚¹ãƒªãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰é€ä¿¡]
```

## ğŸ› ï¸ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ»ä½¿ç”¨æ–¹æ³•

### ğŸ“‹ å¿…è¦æ¡ä»¶

- **Python 3.11ä»¥ä¸Š**
- **InfluxDB 2.0ä»¥ä¸Š** (ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ç”¨)
- **ESP32ãƒ‡ãƒã‚¤ã‚¹**: M5Stack Unit Cam + USB CDC Receiver
- **ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**: `pyproject.toml`ã§è‡ªå‹•ç®¡ç†

### uvã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å‰ã«ã€uvã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼š

```bash
# MacãŠã‚ˆã³Linux
curl -LsSf https://astral.sh/uv/install.sh | sh

# Windows
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

1. **ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**:
   ```bash
   cd server/sensor_data_reciver
   # uvã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ (æ¨å¥¨)
   uv sync
   # pipã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
   # pip install -e .
   ```

2. **ç’°å¢ƒè¨­å®š**:
   ```bash
   # .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆInfluxDBä½¿ç”¨æ™‚ï¼‰
   cp .env.example .env
   # .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦InfluxDBè¨­å®šã‚’å…¥åŠ›
   ```

3. **InfluxDBã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—** (ã‚ªãƒ—ã‚·ãƒ§ãƒ³):
   ```bash
   # Dockerã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
   docker run -d -p 8086:8086 \
     -e DOCKER_INFLUXDB_INIT_MODE=setup \
     -e DOCKER_INFLUXDB_INIT_USERNAME=admin \
     -e DOCKER_INFLUXDB_INIT_PASSWORD=password \
     -e DOCKER_INFLUXDB_INIT_ORG=farmverse \
     -e DOCKER_INFLUXDB_INIT_BUCKET=sensor_data \
     influxdb:2.7
   ```

### ğŸ’» å®Ÿè¡Œæ–¹æ³•

**åŸºæœ¬å®Ÿè¡Œ**:
```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§å®Ÿè¡Œ
uv run python app.py

# ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆã‚’æŒ‡å®š
uv run python app.py -p /dev/ttyUSB0

# ãƒãƒ¼ãƒˆã¨ãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆã‚’æŒ‡å®š
uv run python app.py -p /dev/cu.usbmodem12341 -b 115200
```

**ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°**:
- `-p`, `--port`: ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: config.SERIAL_PORT)
- `-b`, `--baud`: ãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: config.BAUD_RATE)

**ç’°å¢ƒå¤‰æ•°**:
- `INFLUXDB_URL`: InfluxDBã®URL (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: http://localhost:8086)
- `INFLUXDB_TOKEN`: InfluxDBã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
- `INFLUXDB_ORG`: InfluxDBçµ„ç¹”å
- `INFLUXDB_BUCKET`: InfluxDBãƒã‚±ãƒƒãƒˆå

**ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ä¾‹**:
```bash
# InfluxDBçµ±åˆã‚ã‚Š
export INFLUXDB_TOKEN="your_token_here"
export INFLUXDB_ORG="farmverse"
export INFLUXDB_BUCKET="sensor_data"
uv run python app.py -p /dev/ttyUSB0

# InfluxDBçµ±åˆãªã—ï¼ˆç”»åƒä¿å­˜ã®ã¿ï¼‰
uv run python app.py -p /dev/ttyUSB0
```

ã‚µãƒ¼ãƒãƒ¼ã¯èµ·å‹•ã™ã‚‹ã¨ä»¥ä¸‹ã®å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™ï¼š
- ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å—ä¿¡
- å—ä¿¡ç”»åƒã®`images/`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ä¿å­˜
- InfluxDBã¸ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿è¨˜éŒ²ï¼ˆè¨­å®šæ™‚ï¼‰
- ãƒ‡ãƒã‚¤ã‚¹ã¸ã®å‹•çš„ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡

### ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

åŒ…æ‹¬çš„ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆï¼ˆ53å€‹ã®ãƒ†ã‚¹ãƒˆï¼‰ã‚’å®Ÿè¡Œï¼š

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
uv run pytest

# å˜ä½“ãƒ†ã‚¹ãƒˆã®ã¿
uv run pytest tests/unit

# çµ±åˆãƒ†ã‚¹ãƒˆã®ã¿
uv run pytest tests/integration

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ããƒ†ã‚¹ãƒˆ
uv run pytest --cov=. --cov-report=html

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
uv run pytest tests/unit/test_influxdb_client.py -v
```

## ğŸ“‹ ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ 

```
[START_MARKER (4B)] [MAC Address (6B)] [Frame Type (1B)] [Sequence Num (4B)] [Data Length (4B)] [Data (variable)] [Checksum (4B)] [END_MARKER (4B)]
```

### ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ã‚µã‚¤ã‚º | èª¬æ˜ | å€¤ |
|-----------|--------|------|-----|
| START_MARKER | 4B | ãƒ•ãƒ¬ãƒ¼ãƒ é–‹å§‹ãƒãƒ¼ã‚«ãƒ¼ | `0xfa 0xce 0xaa 0xbb` |
| MAC Address | 6B | é€ä¿¡å…ƒãƒ‡ãƒã‚¤ã‚¹ã®MACã‚¢ãƒ‰ãƒ¬ã‚¹ | ä¾‹: `aa:bb:cc:dd:ee:ff` |
| Frame Type | 1B | ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ— | 1:HASH, 2:DATA, 3:EOF |
| Sequence Num | 4B | ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå· (ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³) | 0ï½n |
| Data Length | 4B | ãƒ‡ãƒ¼ã‚¿é•· (ãƒ“ãƒƒã‚°ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³) | 0ï½MAX_DATA_LEN |
| Data | å¯å¤‰ | ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ | ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—ã«ä¾å­˜ |
| Checksum | 4B | ãƒ‡ãƒ¼ã‚¿éƒ¨åˆ†ã®ãƒã‚§ãƒƒã‚¯ã‚µãƒ  | CRC32 |
| END_MARKER | 4B | ãƒ•ãƒ¬ãƒ¼ãƒ çµ‚äº†ãƒãƒ¼ã‚«ãƒ¼ | `0xcd 0xef 0x56 0x78` |

### ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¿ã‚¤ãƒ—è©³ç´°

#### 1. HASHãƒ•ãƒ¬ãƒ¼ãƒ  (Type: 1)
- **ç”¨é€”**: ç”»åƒé€ä¿¡é–‹å§‹ãƒ»ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±é€ä¿¡
- **ãƒ‡ãƒ¼ã‚¿**: ç”»åƒãƒãƒƒã‚·ãƒ¥å€¤ã€é›»åœ§ãƒ»æ¸©åº¦ãƒ‡ãƒ¼ã‚¿
- **å‡¦ç†**: InfluxDBã¸ã®è¨˜éŒ²ã€ã‚¹ãƒªãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ

#### 2. DATAãƒ•ãƒ¬ãƒ¼ãƒ  (Type: 2)
- **ç”¨é€”**: ç”»åƒãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²é€ä¿¡
- **ãƒ‡ãƒ¼ã‚¿**: JPEGç”»åƒãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨
- **å‡¦ç†**: MACã‚¢ãƒ‰ãƒ¬ã‚¹åˆ¥ãƒãƒƒãƒ•ã‚¡ã«è“„ç©

#### 3. EOFãƒ•ãƒ¬ãƒ¼ãƒ  (Type: 3)
- **ç”¨é€”**: ç”»åƒé€ä¿¡å®Œäº†é€šçŸ¥
- **ãƒ‡ãƒ¼ã‚¿**: ãªã—
- **å‡¦ç†**: è“„ç©ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ãƒ»çµ±è¨ˆæ›´æ–°

## âš™ï¸ è¨­å®šãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### ç’°å¢ƒå¤‰æ•°è¨­å®š

| å¤‰æ•°å | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
|--------|------|--------------|
| `INFLUXDB_URL` | InfluxDBã‚µãƒ¼ãƒãƒ¼URL | `http://localhost:8086` |
| `INFLUXDB_TOKEN` | InfluxDBã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ | ãªã—ï¼ˆå¿…é ˆï¼‰ |
| `INFLUXDB_ORG` | InfluxDBçµ„ç¹”å | `farmverse` |
| `INFLUXDB_BUCKET` | InfluxDBãƒã‚±ãƒƒãƒˆå | `sensor_data` |
| `SERIAL_PORT` | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆ | `/dev/ttyACM0` |
| `BAUD_RATE` | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒœãƒ¼ãƒ¬ãƒ¼ãƒˆ | `115200` |

### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

```python
# config/settings.py ã§è¨­å®šå¯èƒ½ãªé …ç›®
MAX_DATA_LEN = 1024           # æœ€å¤§ãƒ‡ãƒ¼ã‚¿é•·
IMAGE_TIMEOUT = 30            # ç”»åƒå—ä¿¡ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
DEFAULT_SLEEP_DURATION = 60   # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“ï¼ˆç§’ï¼‰
LOW_VOLTAGE_THRESHOLD = 8     # ä½é›»åœ§é–¾å€¤ï¼ˆ%ï¼‰
INFLUXDB_TIMEOUT_SECONDS = 3  # InfluxDBæ›¸ãè¾¼ã¿ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
```

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºä¾‹

#### 1. ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“èª¿æ•´
```python
# processors/sleep_controller.py
def determine_sleep_duration(voltage_percentage: float) -> int:
    if voltage_percentage < 8:
        return 3600  # 1æ™‚é–“ã‚¹ãƒªãƒ¼ãƒ—
    elif voltage_percentage < 20:
        return 300   # 5åˆ†ã‚¹ãƒªãƒ¼ãƒ—
    else:
        return 60    # 1åˆ†ã‚¹ãƒªãƒ¼ãƒ—
```

#### 2. InfluxDBè¨˜éŒ²é …ç›®è¿½åŠ 
```python
# storage/influxdb_client.py
def write_sensor_data(self, sender_mac, voltage=None, temperature=None, 
                     custom_field=None):
    # ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ å‡¦ç†
```

## ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š

```bash
# ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
export RUST_LOG=debug
uv run python app.py

# ç‰¹å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ­ã‚°ã®ã¿
export RUST_LOG=storage.influxdb_client=debug
uv run python app.py
```

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ³• |
|------|------|----------|
| ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆæ¥ç¶šå¤±æ•— | ãƒãƒ¼ãƒˆåãƒ»æ¨©é™ | ãƒ‡ãƒã‚¤ã‚¹ç¢ºèªã€æ¨©é™è¨­å®š |
| InfluxDBæ¥ç¶šã‚¨ãƒ©ãƒ¼ | URLãƒ»ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | è¨­å®šç¢ºèªã€ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ç¢ºèª |
| ç”»åƒä¿å­˜å¤±æ•— | ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ãƒ»æ¨©é™ | å®¹é‡ç¢ºèªã€æ¨©é™è¨­å®š |
| ãƒ•ãƒ¬ãƒ¼ãƒ è§£æã‚¨ãƒ©ãƒ¼ | ãƒ‡ãƒ¼ã‚¿ç ´æãƒ»åŒæœŸãšã‚Œ | ã‚·ãƒªã‚¢ãƒ«è¨­å®šã€ã‚±ãƒ¼ãƒ–ãƒ«ç¢ºèª |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å¢—åŠ  | ã‚¿ã‚¹ã‚¯ãƒªãƒ¼ã‚¯ | asyncã‚¿ã‚¹ã‚¯ç®¡ç†ã®ç¢ºèª |

### ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½

#### 1. è©³ç´°ãƒ­ã‚°å‡ºåŠ›
```python
# utils/logging_config.py ã§ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«èª¿æ•´
import logging
logging.getLogger('protocol.frame_parser').setLevel(logging.DEBUG)
```

#### 2. çµ±è¨ˆæƒ…å ±ç›£è¦–
```python
# çµ±è¨ˆæƒ…å ±ã®å®šæœŸå‡ºåŠ›ï¼ˆ10ç§’é–“éš”ï¼‰
# received_images: å—ä¿¡ç”»åƒæ•°
# total_bytes: ç·å—ä¿¡ãƒã‚¤ãƒˆæ•°
# buffer_count: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒƒãƒ•ã‚¡æ•°
```

#### 3. InfluxDBæ›¸ãè¾¼ã¿ç›£è¦–
```python
# éåŒæœŸã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹ç›£è¦–
# active_tasks: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ã‚¹ã‚¯æ•°
# completed_tasks: å®Œäº†ã‚¿ã‚¹ã‚¯æ•°
# failed_writes: æ›¸ãè¾¼ã¿å¤±æ•—æ•°
```

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ»ä»•æ§˜

### ã‚·ã‚¹ãƒ†ãƒ æ€§èƒ½

| é …ç›® | ä»•æ§˜ |
|------|------|
| **æœ€å¤§åŒæ™‚ãƒ‡ãƒã‚¤ã‚¹æ•°** | 16å°ï¼ˆMACã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ™ãƒ¼ã‚¹ç®¡ç†ï¼‰ |
| **ç”»åƒå‡¦ç†èƒ½åŠ›** | ~30KB/ç”»åƒã€~15-20ç§’/é€ä¿¡ |
| **InfluxDBæ›¸ãè¾¼ã¿** | éåŒæœŸã€3ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡** | ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã«ã‚ˆã‚‹æœ€é©åŒ– |
| **ãƒ‡ãƒ¼ã‚¿ä¿æŒ** | ç„¡åˆ¶é™ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ä¾å­˜ï¼‰ |

### é€šä¿¡ä»•æ§˜

| ãƒ—ãƒ­ãƒˆã‚³ãƒ« | ä»•æ§˜ |
|-----------|------|
| **ESP-NOW** | 200ãƒã‚¤ãƒˆãƒãƒ£ãƒ³ã‚¯ã€100msé–“éš” |
| **ã‚·ãƒªã‚¢ãƒ«é€šä¿¡** | USB CDCã€115200bps |
| **ãƒ•ãƒ¬ãƒ¼ãƒ åŒæœŸ** | START/END_MARKER |
| **ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼** | SHA256ãƒãƒƒã‚·ãƒ¥ã€CRC32ãƒã‚§ãƒƒã‚¯ã‚µãƒ  |

### é›»åŠ›ç®¡ç†

| é›»åœ§ãƒ¬ãƒ™ãƒ« | ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“ | å‹•ä½œ |
|-----------|-------------|------|
| **0-7%** | 3600ç§’ï¼ˆ1æ™‚é–“ï¼‰ | ç”»åƒé€ä¿¡ã‚¹ã‚­ãƒƒãƒ— |
| **8-19%** | 300ç§’ï¼ˆ5åˆ†ï¼‰ | ä½é »åº¦é€ä¿¡ |
| **20-100%** | 60ç§’ï¼ˆ1åˆ†ï¼‰ | é€šå¸¸å‹•ä½œ |

## ğŸš€ æœ€æ–°ã®å®Ÿè£…çŠ¶æ³

### âœ… å®Œäº†ã—ãŸæ©Ÿèƒ½

#### ã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åˆ·æ–°
- **ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼è¨­è¨ˆ**: config, protocol, processors, storageåˆ†é›¢
- **éåŒæœŸå‡¦ç†**: asyncioå®Œå…¨å¯¾å¿œã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢
- **åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ**: 53å€‹ã®ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹é«˜ã„ã‚«ãƒãƒ¬ãƒƒã‚¸
- **å‹å®‰å…¨æ€§**: å‹ãƒ’ãƒ³ãƒˆå®Œå‚™ã€é™çš„è§£æå¯¾å¿œ

#### InfluxDBçµ±åˆãƒ»æœ€é©åŒ–
- **asyncæ›¸ãè¾¼ã¿**: éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ãƒ»é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- **ã‚¿ã‚¹ã‚¯ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯é˜²æ­¢æ©Ÿèƒ½
- **å…¨é›»åœ§è¨˜éŒ²**: 0-100%ã®é›»åœ§ãƒ‡ãƒ¼ã‚¿å®Œå…¨è¨˜éŒ²
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: å …ç‰¢ãªæ¥ç¶šãƒ»æ›¸ãè¾¼ã¿å‡¦ç†

#### ã‚¹ãƒªãƒ¼ãƒ—åˆ¶å¾¡ã‚·ã‚¹ãƒ†ãƒ 
- **å‹•çš„åˆ¶å¾¡**: é›»åœ§ãƒ¬ãƒ™ãƒ«å¿œç­”å‹ã‚¹ãƒªãƒ¼ãƒ—æ™‚é–“
- **HASHãƒ•ãƒ¬ãƒ¼ãƒ å‡¦ç†**: å³åº§ã®ã‚¹ãƒªãƒ¼ãƒ—ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
- **ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹**: å€‹åˆ¥ãƒ‡ãƒã‚¤ã‚¹ã”ã¨ã®æœ€é©åŒ–
- **é›»åŠ›åŠ¹ç‡**: æœ€å¤§87%ã®é›»åŠ›å‰Šæ¸›åŠ¹æœ

#### å“è³ªãƒ»ä¿å®ˆæ€§
- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**: ãƒ¬ã‚¬ã‚·ãƒ¼ã‚³ãƒ¼ãƒ‰ã®å®Œå…¨åˆ·æ–°
- **è¨­å®šå¤–éƒ¨åŒ–**: ç’°å¢ƒå¤‰æ•°ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«åˆ†é›¢
- **ãƒ­ã‚°ä½“ç³»**: æ§‹é€ åŒ–ãƒ­ã‚°ãƒ»ãƒ‡ãƒãƒƒã‚°æ”¯æ´
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: åŒ…æ‹¬çš„ãªæŠ€è¡“æ–‡æ›¸

---

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»è²¢çŒ®

### ãƒ©ã‚¤ã‚»ãƒ³ã‚¹
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯[MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹](../../LICENSE)ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

### è²¢çŒ®ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
- **ãƒã‚°å ±å‘Š**: GitHubã®Issueã‚’ã”åˆ©ç”¨ãã ã•ã„
- **æ©Ÿèƒ½ææ¡ˆ**: Pull Requestã‚’æ­“è¿ã—ã¾ã™
- **æŠ€è¡“ã‚µãƒãƒ¼ãƒˆ**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®å……å®Ÿ

**FarmVerse Project** - æŒç¶šå¯èƒ½ãªè¾²æ¥­ã®ãŸã‚ã®IoTãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
